const data = {
	"cell": {
		"augurs": {
			"base": {
				"claim_1_name": "claim_custom_workspaces",
				"claim_1_desc": "claim_custom_workspaces_description",
				"claim_2_desc": "claim_artisan_crafters_description",
				"claim_2_name": "claim_artisan_crafters",
				"claim_3_desc": "claim_radiant_archive_description",
				"claim_3_name": "claim_radiant_archive",
				"claim_4_desc": "claim_exotic_weave_description",
				"claim_4_name": "claim_exotic_weave",
				"claim_5_desc": "claim_quintessic_loom_description",
				"claim_5_name": "claim_quintessic_loom",
				"claim_6_name": "claim_production",
				"claim_7_name": "claim_production",
				"claim_9_name": "claim_production",
				"claim_10_name": "claim_production",
				"claim_11_desc": "claim_laboratory_description",
				"claim_11_name": "claim_laboratory",
				"claim_12_desc": "claim_charmflair_description",
				"claim_12_name": "claim_charmflair",
				"claim_13_desc": "claim_popular_science_description",
				"claim_13_name": "claim_popular_science",
				"claim_14_desc": "claim_wormhole_gate_description",
				"claim_14_name": "claim_wormhole_gate",
				"claim_15_desc": "claim_medical_bay_description",
				"claim_15_name": "claim_medical_bay",
				"claim_bridge_3_4": "0",
				"claim_bridge_7_12": "0",
				"claim_bridge_9_14": "0",
				"claim_bridge_12_13": "0",
				"claim_bridge_13_14": "0",
				"cell_description": "cell_augurs_description",
				"cell_xp_condition": "cell_augurs_xp_condition",
				"hunting_grounds_type": "cell_augurs_hunting_grounds_type",
				"hunting_grounds_description": "cell_augurs_hunting_grounds_description",
				"upgrade_14_check_1": "1",
				"upgrade_22_check_1": "1"
			},
			"cellability": ["elementary", "case_file_drive", "cut_loose", "drift_compatible", "rescue_warp", "spirits_perch", "uxies_promise", "experienced"],
      "upgrade": [{
          "name": "cell_upgrade_altara",
          "description": "cell_upgrade_altara_description",
          "numboxes": "1"
        }, {
          "name": "cell_upgrade_aramis",
          "description": "cell_upgrade_aramis_description",
          "numboxes": "1"
        }, {
          "name": "cell_upgrade_benjamin",
          "description": "cell_upgrade_benjamin_description",
          "numboxes": "1"
        }, {
          "name": "cell_upgrade_hal",
          "description": "cell_upgrade_hal_description",
          "numboxes": "1"
        }, {
          "name": "cell_upgrade_troy",
          "description": "cell_upgrade_troy_description",
          "numboxes": "1"
        }],        
      "boon": []
		},
		"couriers": {
			"base": {
				"claim_1_name": "claim_artisan_crafters",
				"claim_1_desc": "claim_artisan_crafters_description",
				"claim_2_name": "claim_production",
				"claim_3_desc": "claim_side_shipments_description",
				"claim_3_name": "claim_side_shipments",
				"claim_4_desc": "claim_terrain_maps_description",
				"claim_4_name": "claim_terrain_maps",
				"claim_5_desc": "claim_medical_bay_description",
				"claim_5_name": "claim_medical_bay",
				"claim_6_name": "claim_production",
				"claim_7_name": "claim_production",
				"claim_9_name": "claim_production",
				"claim_10_name": "claim_production",
				"claim_11_desc": "claim_low_emissions_energy_description",
				"claim_11_name": "claim_low_emissions_energy",
				"claim_12_desc": "claim_wormhole_gate_description",
				"claim_12_name": "claim_wormhole_gate",
				"claim_13_desc": "claim_fleet_description",
				"claim_13_name": "claim_fleet",
				"claim_14_desc": "claim_mobile_city_description",
				"claim_14_name": "claim_mobile_city",
				"claim_15_desc": "claim_warehouses_description",
				"claim_15_name": "claim_warehouses",
				"claim_bridge_3_4": "0",
				"claim_bridge_6_11": "0",
				"claim_bridge_12_13": "0",
				"claim_bridge_13_14": "0",
				"cohort1_description": "vehicle_edges_flaws",
				"cohort1_name": "vehicle",
				"cohort1_subtype": "rover_dropjet_other",
				"cohort1_type": "expert",
				"cell_description": "cell_couriers_description",
				"cell_xp_condition": "cell_couriers_description_xp_condition",
				"hunting_grounds_type": "cell_couriers_hunting_grounds_type",
				"hunting_grounds_description": "cell_couriers_hunting_grounds_description",
				"upgrade_6_check_1": "1",
				"upgrade_20_check_1": "1"
			},
			"cellability": ["go_for_miles", "all_hands", "distributed_weight", "experts_talk_logistics", "friendly", "one_of_us", "punch_it", "experienced"],
      "upgrade": [],
      "boon": []
		},
		"magpies": {
			"base": {
				"claim_1_name": "claim_assembly_arms",
				"claim_1_desc": "claim_assembly_arms_description",
				"claim_2_desc": "claim_artisan_crafters_description",
				"claim_2_name": "claim_artisan_crafters",
				"claim_3_desc": "claim_minifacturing_description",
				"claim_3_name": "claim_minifacturing",
				"claim_4_desc": "claim_radiant_archive_description",
				"claim_4_name": "claim_radiant_archive",
				"claim_5_desc": "claim_laboratory_description",
				"claim_5_name": "claim_laboratory",
				"claim_6_name": "claim_production",
				"claim_7_name": "claim_production",
				"claim_9_name": "claim_production",
				"claim_10_name": "claim_production",
				"claim_11_desc": "claim_custom_workspaces_description",
				"claim_11_name": "claim_custom_workspaces",
				"claim_12_desc": "claim_low_emissions_energy_description",
				"claim_12_name": "claim_low_emissions_energy",
				"claim_13_desc": "claim_open_license_specs_description",
				"claim_13_name": "claim_open_license_specs",
				"claim_14_desc": "claim_repair_shop_description",
				"claim_14_name": "claim_repair_shop",
				"claim_15_desc": "claim_adaptive_hardware_description",
				"claim_15_name": "claim_adaptive_hardware",
				"claim_bridge_1_2": "0",
				"claim_bridge_2_3": "0",
				"claim_bridge_3_4": "0",
				"claim_bridge_4_5": "0",
				"claim_bridge_11_12": "0",
				"claim_bridge_14_15": "0",
				"claim_bridge_12_13": "0",
				"claim_bridge_13_14": "0",
				"cell_description": "cell_magpies_description",
				"cell_xp_condition": "cell_magpies_xp_condition",
				"hunting_grounds_type": "cell_magpies_hunting_grounds_type",
				"hunting_grounds_description": "cell_magpies_hunting_grounds_description",
				"upgrade_11_check_1": "1",
				"upgrade_20_check_1": "1"
			},
			"cellability": ["feather_transform", "custom_os", "engineers", "foundation_frames", "resilience", "scrapyards", "sum_of_its_parts", "experienced"],
			"upgrade": [],
      "boon": []
		},
		"rangers": {
			"base": {
				"claim_1_desc": "claim_civilian_testimonies_description",
				"claim_1_name": "claim_civilian_testimonies",
				"claim_2_desc": "claim_artisan_crafters_description",
				"claim_2_name": "claim_artisan_crafters",
				"claim_3_desc": "claim_salvage_side_ops_description",
				"claim_3_name": "claim_salvage_side_ops",
				"claim_4_desc": "claim_field_medicine_description",
				"claim_4_name": "claim_field_medicine",
				"claim_5_desc": "claim_medical_bay_description",
				"claim_5_name": "claim_medical_bay",
				"claim_6_desc": "claim_combat_sims_description",
				"claim_6_name": "claim_combat_sims",
				"claim_7_name": "claim_production",
				"claim_9_name": "claim_production",
				"claim_10_name": "claim_production",
				"claim_11_desc": "claim_training_facilities_description",
				"claim_11_name": "claim_training_facilities",
				"claim_12_name": "claim_production",
				"claim_13_desc": "claim_warehouses_description",
				"claim_13_name": "claim_warehouses",
				"claim_14_desc": "claim_wormhole_gate_description",
				"claim_14_name": "claim_wormhole_gate",
				"claim_15_desc": "claim_passive_camo_description",
				"claim_15_name": "claim_passive_camo",
				"claim_bridge_2_3": "0",
				"claim_bridge_3_4": "0",
				"claim_bridge_9_14": "0",
				"claim_bridge_12_13": "0",
				"claim_bridge_13_14": "0",
				"cell_description": "cell_rangers_description",
				"cell_xp_condition": "cell_rangers_xp_condition",
				"hunting_grounds_type": "cell_rangers_hunting_grounds_type",
				"hunting_grounds_description": "cell_rangers_hunting_grounds_description",
				"upgrade_7_check_1": "1",
				"upgrade_21_check_1": "1"
			},
			"cellability": ["six_coyotes", "disaster_relief", "the_easy_way", "forged_in_fire", "reassuring", "synchronized", "war_dogs", "experienced"],
			"upgrade": [],
      "boon": []
		},
		"silvers": {
			"base": {
				"claim_1_desc": "claim_intercontinental_aid_description",
				"claim_1_name": "claim_intercontinental_aid",
				"claim_2_desc": "claim_artisan_crafters_description",
				"claim_2_name": "claim_artisan_crafters",
				"claim_3_desc": "claim_positive_spin_description",
				"claim_3_name": "claim_positive_spin",
				"claim_4_desc": "claim_cover_operation_description",
				"claim_4_name": "claim_cover_operation",
				"claim_5_desc": "claim_cover_identities_description",
				"claim_5_name": "claim_cover_identities",
				"claim_6_name": "claim_production",
				"claim_7_name": "claim_production",
				"claim_9_name": "claim_production",
				"claim_10_desc": "claim_luxury_venue_description",
				"claim_10_name": "claim_luxury_venue",
				"claim_11_name": "claim_production",
				"claim_12_desc": "claim_fashion_experts_description",
				"claim_12_name": "claim_fashion_experts",
				"claim_13_desc": "claim_black_market_contacts_description",
				"claim_13_name": "claim_black_market_contacts",
				"claim_14_desc": "claim_friends_in_low_places_description",
				"claim_14_name": "claim_friends_in_low_places",
				"claim_15_desc": "claim_expose_description",
				"claim_15_name": "claim_expose",
				"claim_bridge_2_3": "0",
				"claim_bridge_3_4": "0",
				"claim_bridge_12_13": "0",
				"claim_bridge_13_14": "0",
				"cell_description": "cell_silvers_description",
				"cell_xp_condition": "cell_silvers_xp_condition",
				"hunting_grounds_type": "cell_silvers_hunting_grounds_type",
				"hunting_grounds_description": "cell_silvers_hunting_grounds_description",
				"upgrade_20_check_1": "1",
				"upgrade_22_check_1": "1"
			},
			"cellability": ["amiable", "cant_hate_us", "captivating", "heartfelt", "locals", "suppliers_network", "view_from_the_top", "experienced"],
			"upgrade": [],
      "boon": []
		}
},
	"playbook": {
		"agnite": {
	    "ability": ["awakened_dreamer","synthesis","seasoned","angelic", "bounces_back", "only_a_child", "playful", "sneaky", "underfoot", "hide_n_seek", "luck", "naivete","wonder"],
	    "base": {
      "friends_title": "playbook_agnite_friends_title",
      "lurk": "2",
      "trick": "1",
      "gatherinfo1": "gatherinfo_whats_their_intention",
      "gatherinfo2": "gatherinfo_what_might_I_suspect",
      "gatherinfo3": "gatherinfo_whats_the_danger_here",
      "gatherinfo4": "gatherinfo_how_can_I_find",
      "gatherinfo5": "gatherinfo_how_can_I_help_here",
      "gatherinfo6": "gatherinfo_whats_going_on",
      "gatherinfo7": "gatherinfo_detail_for_plan",
      "playbook_description": "playbook_agnite_description",
      "playbook_background": "playbook_agnite_background",
      "playbook_eminence": "playbook_agnite_eminence",
      "xp_condition": "playbook_agnite_xp_condition"
    },
    "playbookitem": [{
      "bold": "1",
      "name": "playbook_item_arts_and_crafts",
      "description": "playbook_item_arts_and_crafts_description",
      "numboxes": "1"
    }, {
      "name": "playbook_item_backpack",
      "description": "playbook_item_backpack_description",
      "numboxes": "1"
    }, {		
      "name": "playbook_item_candy",
      "description": "playbook_item_candy_description",
      "numboxes": "1"
    }, {
      "bold": "1",
      "name": "playbook_item_fine_toy",
      "description": "playbook_item_fine_toy_description",
      "numboxes": "1"
    }, {
      "name": "playbook_item_relic_gadget",
      "description": "playbook_item_relic_gadget_description",
      "numboxes": "1"
    }]
  },
"dahlian": {
  "ability": ["awakened_dreamer","synthesis","seasoned","jack_of_all_trades", "behind_the_mask", "guile", "mirror_mirror", "trade_network", "worldly", "dahlias_doorway", "dance_of_masks", "metamorphosis", "puppet_show"],
  "base": {
    "friends_title": "playbook_dahlian_friends_title",
    "finesse": "1",
    "trick": "2",
    "gatherinfo1": "gatherinfo_whats_their_intention",
    "gatherinfo2": "gatherinfo_what_might_I_suspect",
    "gatherinfo3": "gatherinfo_whats_the_danger_here",
    "gatherinfo4": "gatherinfo_how_can_I_find",
    "gatherinfo5": "gatherinfo_how_can_I_help_here",
    "gatherinfo6": "gatherinfo_whats_going_on",
    "gatherinfo7": "gatherinfo_detail_for_plan",
    "playbook_description": "playbook_dahlian_description",
    "playbook_background": "playbook_dahlian_background",
    "playbook_eminence": "playbook_dahlian_eminence", 
    "xp_condition": "playbook_dahlian_xp_condition"
  },
  "playbookitem": [{
    "name": "playbook_item_concealed_weapon",
    "description": "playbook_item_concealed_weapon_description",
    "numboxes": "1"
  }, {
    "bold": "1",
    "name": "playbook_item_fine_costume",
    "description": "playbook_item_fine_costume_description",
    "numboxes": "0"
  }, {
    "bold": "1",
    "name": "playbook_item_fine_disguise_kit",
    "description": "playbook_item_fine_disguise_kit_description",
    "numboxes": "1"
  }, {
    "bold": "1",
    "name": "playbook_item_fine_lockpicks",
    "description": "playbook_item_fine_lockpicks_description",
    "numboxes": "1"
  }, {
    "name": "playbook_item_loaded_dice",
    "description": "playbook_item_loaded_dice_description",
    "numboxes": "1"
  }, {
    "name": "playbook_item_trinkets",
    "description": "playbook_item_trinkets_description",
    "numboxes": "1"
  }]
},
"evan": {
  "ability": ["awakened_dreamer","synthesis","seasoned","natures_bond", "comfort_food",    "healer", "mother_bear", "robust", "stalwart", "zbri_hunter", "anima", "piggyback", "smothering"],
  "base": {
  "friends_title": "playbook_evan_friends_title",
  "dream": "1",
  "consort": "2",
  "gatherinfo1": "gatherinfo_whats_their_intention",
  "gatherinfo2": "gatherinfo_what_might_I_suspect",
  "gatherinfo3": "gatherinfo_whats_the_danger_here",
  "gatherinfo4": "gatherinfo_how_can_I_find",
  "gatherinfo5": "gatherinfo_how_can_I_help_here",
  "gatherinfo6": "gatherinfo_whats_going_on",
  "gatherinfo7": "gatherinfo_detail_for_plan",
  "playbook_description": "playbook_evan_description",
  "playbook_background": "playbook_evan_background",
  "playbook_eminence": "playbook_evan_eminence",
  "xp_condition": "playbook_evan_xp_condition"
  },
  "playbookitem": [{
  "name": "playbook_item_camo_gear",  
  "description": "playbook_item_camo_gear_description",   
  "numboxes": "2"
  }, {
  "name": "playbook_item_eva_medallion",
  "description": "playbook_item_eva_medallion_description",
  "numboxes": "0"
  }, {
    "name": "playbook_item_farming_implements",
    "description": "playbook_item_farming_implements_description",
    "numboxes": "1"
  }, {
    "name": "playbook_item_fresh_food",
    "description": "playbook_item_fresh_food_description",
    "numboxes": "1"
  }, {
    "name": "playbook_item_hunting_companion",
    "description": "playbook_item_hunting_companion_description",
    "numboxes": "0"
  }, {
  "name": "playbook_item_medicine_satchel",
  "description": "playbook_item_medicine_satchel_description",
  "numboxes": "1"
  }]
  },
  "joanite": {
    "ability": ["awakened_dreamer","synthesis","seasoned","master_at_arms", "archer", "bastion", "cavalry", "hard_to_kill", "virtuous", "battle", "righteousness", "sacrifice", "winters_cloak"],
    "base": {
    "friends_title": "playbook_joanite_friends_title",
    "fight": "2",
    "gatherinfo1": "gatherinfo_whats_their_intention",
    "gatherinfo2": "gatherinfo_what_might_I_suspect",
    "gatherinfo3": "gatherinfo_whats_the_danger_here",
    "gatherinfo4": "gatherinfo_how_can_I_find",
    "gatherinfo5": "gatherinfo_how_can_I_help_here",
    "gatherinfo6": "gatherinfo_whats_going_on",
    "gatherinfo7": "gatherinfo_detail_for_plan",
    "playbook_description": "playbook_joanite_description",
    "playbook_background": "playbook_joanite_background",
    "playbook_eminence": "playbook_joanite_eminence",
    "force": "1",
    "xp_condition": "playbook_joanite_xp_condition"
    },
    "playbookitem": [ {
    "bold": "1",
    "name": "playbook_item_fine_armor",
    "description": "playbook_item_fine_armor_description",
    "numboxes": "2"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_hand_weapon",
    "description": "playbook_item_fine_hand_weapon_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_longbow",
    "description": "playbook_item_fine_longbow_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_shield",
    "description": "playbook_item_fine_shield_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_metalworking_tools",
    "description": "playbook_item_metalworking_tools_description",
    "numboxes": "2"
    }, {
    "name": "playbook_item_training_token",
    "description": "playbook_item_training_token_description",
    "numboxes": "0"
    }]
  },
  "magdalite": {
    "ability": ["awakened_dreamer","synthesis","seasoned","intimacy","apothecary","enchanting","indulgent","maskers_dance","pledge","manifestation","nitrous","passion","treason"],
    "base": {
    "friends_title": "playbook_magdalite_friends_title",
    "finesse": "1",
    "gatherinfo1": "gatherinfo_whats_their_intention",
    "gatherinfo2": "gatherinfo_what_might_I_suspect",
    "gatherinfo3": "gatherinfo_whats_the_danger_here",
    "gatherinfo4": "gatherinfo_how_can_I_find",
    "gatherinfo5": "gatherinfo_how_can_I_help_here",
    "gatherinfo6": "gatherinfo_whats_going_on",
    "gatherinfo7": "gatherinfo_detail_for_plan",
    "playbook_description": "playbook_magdalite_description",
    "playbook_background": "playbook_magdalite_background",
    "playbook_eminence": "playbook_magdalite_eminence",
    "consort": "2",
    "xp_condition": "playbook_magdalite_xp_condition"
    },
    "playbookitem": [{
    "name": "playbook_item_drug_satchel",
    "description": "playbook_item_drug_satchel_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_clothes",
    "description": "playbook_item_fine_clothes_description",
    "numboxes": "0"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_musical_instrument",
    "description": "playbook_item_fine_musical_instrument_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_luxury_item",
    "description": "playbook_item_luxury_item_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_mask",
    "description": "playbook_item_mask_description",
    "numboxes": "0"
    }, {
    "name": "playbook_item_small_concealed_weapon",
    "description": "playbook_item_small_concealed_weapon_description",
    "numboxes": "1"
    }]
  },
  "Terasheban": {
    "ability": ["awakened_dreamer","synthesis","seasoned","mastermind", "connected", "investigator", "meticulous", "prescience", "scholar", "trailblazer", "tradition", "truthsaying", "habeascorpus"],
    "base": {
    "friends_title": "playbook_Terasheban_friends_title",
    "study": "2",
    "gatherinfo1": "gatherinfo_whats_their_intention",
    "gatherinfo2": "gatherinfo_what_might_I_suspect",
    "gatherinfo3": "gatherinfo_whats_the_danger_here",
    "gatherinfo4": "gatherinfo_how_can_I_find",
    "gatherinfo5": "gatherinfo_how_can_I_help_here",
    "gatherinfo6": "gatherinfo_whats_going_on",
    "gatherinfo7": "gatherinfo_detail_for_plan",
    "playbook_description": "playbook_Terasheban_description",
    "playbook_background": "playbook_Terasheban_background",
    "playbook_eminence": "playbook_Terasheban_eminence",  
    "survey": "1",
    "xp_condition": "playbook_Terasheban_xp_condition"
    },
    "playbookitem": [{
    "name": "playbook_item_books_and_journals",
    "description": "playbook_item_books_and_journals_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_robes",
    "description": "playbook_item_fine_robes_description",
    "numboxes": "0"
    },  {
    "name": "playbook_item_lantern_staff",
    "description": "playbook_item_lantern_staff_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_notebooks",
    "description": "playbook_item_notebooks_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_light_exploration_gear",
    "description": "playbook_item_light_exploration_gear_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_worn_book",
    "description": "playbook_item_worn_book_description",
    "numboxes": "1"
    }]
  },
  "Yagan": {
    "ability": ["awakened_dreamer","synthesis","seasoned","mystic","fleshcrafter","fleshseer","masterbonecrafter","reaper","secondsight","spiritcaller","celticcross","curseofdream","dreamtravel"],
    "base": {
    "friends_title": "playbook_Yagan_friends_title",
    "survey": "1",
    "gatherinfo1": "gatherinfo_whats_their_intention",
    "gatherinfo2": "gatherinfo_what_might_I_suspect",
    "gatherinfo3": "gatherinfo_whats_the_danger_here",
    "gatherinfo4": "gatherinfo_how_can_I_find",
    "gatherinfo5": "gatherinfo_how_can_I_help_here",
    "gatherinfo6": "gatherinfo_whats_going_on",
    "gatherinfo7": "gatherinfo_detail_for_plan",
    "playbook_description": "playbook_Yagan_description",
    "playbook_background": "playbook_Yagan_background",
    "playbook_eminence": "playbook_Yagan_eminence",  
    "trick": "2",
    "xp_condition": "playbook_Yagan_xp_condition"
    },
    "playbookitem": [{
    "name": "playbook_item_fine_ritual_implements",
    "description": "playbook_item_fine_ritual_implements_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_bone_item",
    "description": "playbook_item_fine_bone_item_description",
    "numboxes": "1"
    }, {
    "bold": "1",
    "name": "playbook_item_fine_knife",
    "description": "playbook_item_fine_knife_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_poison_satchel",
    "description": "playbook_item_poison_satchel_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_skin_book",
    "description": "playbook_item_skin_book_description",
    "numboxes": "1"
    }, {
    "name": "playbook_item_spirit_charms",
    "description": "playbook_item_spirit_charms_description",
    "numboxes": "1"
    }]
  }
},
	"factions": {
		"factions1": [{
	"name": "faction_the_asphodel_pinnacle",
	"tier": "V",
	"hold": "S"
}, {
	"name": "faction_tsunami",
	"tier": "III",
	"hold": "S"
}, {
		"name": "faction_asriony_union_of_journalists",
		"tier": "III",
		"hold": "W"
}, {
		"name": "faction_the_order_of_the_spiral",
		"tier": "II",
		"hold": "S"
}, {
	"name": "faction_synaptic_wreath",
	"tier": "I",
	"hold": "S"
}],
"factions2": [{
	"name": "faction_acanthia_citizenship",
	"tier": "V",
	"hold": "S"
}, {
	"name": "faction_astatine_throne",
	"tier": "V",
	"hold": "S"
}, {
	"name": "faction_cedar_phantoms",
	"tier": "IV",
	"hold": "W"
}, {
	"name": "faction_nomothesis_blue",
	"tier": "III",
	"hold": "W"
}, {
	"name": "faction_aqua_regia",
	"tier": "III",
	"hold": "S"
}, {
	"name": "faction_ace_of_hearts",
	"tier": "I",
	"hold": "W"
}],
"factions3": [{
	"name": "faction_malvarose_citizenship",
	"tier": "IV",
	"hold": "S"
}, {
	"name": "faction_rosewhite_academy",
	"tier": "IV",
	"hold": "W"
}, {
	"name": "faction_the_lantern_agency",
	"tier": "III",
	"hold": "S"
}, {
	"name": "faction_pyrehollows",
	"tier": "I",
	"hold": "S"
}],
"factions4": [{
	"name": "faction_meridian_valley_citizenship",
	"tier": "III",
	"hold": "S"
}, {
	"name": "faction_path_of_bluebells",
	"tier": "IV",
	"hold": "W"
}, {
	"name": "faction_meridian_coalition",
	"tier": "III",
	"hold": "S"
}, {
	"name": "faction_leafneedles",
	"tier": "III",
	"hold": "W"
}, {
	"name": "faction_salaphiels_quills",
	"tier": "III",
	"hold": "W"
}, {
	"name": "faction_rust_devils",
	"tier": "I",
	"hold": "S"
}],
"factions5": [{
	"name": "faction_pinelock_citizenship",
	"tier": "III",
	"hold": "W"
}, {
	"name": "faction_the_monstral_fair",
	"tier": "IV",
	"hold": "S"
}, {
	"name": "faction_mistral_research_collective",
	"tier": "II",
	"hold": "S"
}],
"factions6": [{
	"name": "faction_red_empire_citizenship",
	"tier": "II",
	"hold": "W"
}, {
	"name": "faction_red_crowns",
	"tier": "V",
	"hold": "S"
}, {
	"name": "faction_imperial_paladins",
	"tier": "IV",
	"hold": "S"
}, {
	"name": "faction_cardinal_frontier_division",
	"tier": "III",
	"hold": "S"
}, {
	"name": "faction_tango_foxtrot",
	"tier": "II",
	"hold": "S"
}],
"factions7": [{
	"name": "faction_serafin_citizenship",
	"tier": "V",
	"hold": "S"
}, {
	"name": "faction_seraph_architectonics_corps",
	"tier": "IV",
	"hold": "S"
}, {
	"name": "faction_spinhawks",
	"tier": "II",
	"hold": "W"
}, {
	"name": "faction_glowjacks",
	"tier": "II",
	"hold": "W"
}, {
	"name": "faction_the_lighthouse",
	"tier": "I",
	"hold": "S"
}, {
	"name": "faction_keening_echos",
	"tier": "I",
	"hold": "W"
}],
"factions8": [{
	"name": "faction_starfire_pelagic_citizenship",
	"tier": "IV",
	"hold": "S"
}, {
	"name": "faction_koiaia_council",
	"tier": "IV",
	"hold": "S"
}, {
	"name": "faction_lunamoths",
	"tier": "III",
	"hold": "S"
 }]
},
	"actions": {
		"insight": ["craft", "hunt", "study", "survey"],
		"prowess": ["fight", "finesse", "lurk", "force"],
		"resolve": ["consort", "dream", "influence", "trick"]
	},
	"traumas": ["adrift", "cold", "haunted", "obsessed", "paranoid", "reckless","shattered", "soft", "unstable", "vicious"],
	"items": [{
		"name": "armor",
		"description": "armor_description",
		"numboxes": "1",
		"short": "1"
	}, {
		"name": "+heavy",
		"description": "+heavy_description",
		"numboxes": "2",
		"short": "1"
	}, {
		"name": "bow",
		"description": "bow_description",
		"numboxes": "1"
	}, {
		"name": "crafting_tools",
		"description": "crafting_tools_description",
		"numboxes": "1"
	}, {
		"name": "documents",
		"description": "documents_description",
    "numboxes": "1",
	}, {
		"name": "exploration_gear",
		"description": "exploration_gear_description",
		"numboxes": "2"
	}, {
		"name": "hand_weapon",
		"description": "hand_weapon_description",
		"numboxes": "1"
	}, {
		"name": "hunting_gear",
		"description": "hunting_gear_description",
		"numboxes": "1"
	}, {
		"name": "large_weapon",
		"description": "large_weapon_description",
		"numboxes": "2"
	}, {
		"name": "ritual_implements",
		"description": "ritual_implements_description",
		"numboxes": "1"
	}, {
		"name": "shield",
		"description": "shield_description",
		"numboxes": "1",
		"short": "1"
	}, {
		"name": "shield_heavy",
		"description": "shield_heavy_description",
    "numboxes": "1",
		"short": "1"
	}, {
		"name": "small_medallion",
		"description": "small_medallion_description",
		"numboxes": "0"
	}, {
		"name": "survival_gear",
		"description": "survival_gear_description",
		"numboxes": "1"
	}, {
		"name": "thrown_weapon",
		"description": "thrown_weapon_description",
		"numboxes": "1"
	}, {
		"name": "unusual_weapon",
		"description": "unusual_weapon_description",
		"numboxes": "1"
	}, {
		"name": "winter_clothes",
		"description": "winter_clothes_description",
		"numboxes": "1"
	}],
	"translatedDefaults": {
		"cohort1_name": "expert",
		"contacts_title": "contacts",
		"factions_title": "factions_title",
		"factions1_header": "factions1",
		"factions2_header": "factions2",
		"factions3_header": "factions3",
		"factions4_header": "factions4",
		"factions5_header": "factions5",
		"friends_title": "friends",
    
    "upgrade_community_1_name": "barber",
    "upgrade_community_1_description": "upgrade_barber_description",
    "upgrade_community_2_name": "kymber",
    "upgrade_community_2_description": "upgrade_kymber_description",
    "upgrade_community_3_name": "kyrt",
    "upgrade_community_3_description": "upgrade_kyrt_description",
    "upgrade_community_4_name": "mek",
    "upgrade_community_4_description": "upgrade_mek_description",
    "upgrade_community_5_name": "veruka",
    "upgrade_community_5_description": "upgrade_veruka_description",
    
    "upgrade_sanctuary_1_name": "bolthole",
    "upgrade_sanctuary_1_description": "upgrade_bolthole_description",
    
		"upgrade_6_name": "dropjet",
		"upgrade_6_description": "upgrade_dropjet_description",
		"upgrade_7_name": "quarters",
		"upgrade_7_description": "upgrade_quarters_description",
		"upgrade_8_name": "warehouses",
		"upgrade_8_description": "upgrade_warehouses_description",
		"upgrade_9_name": "security",
		"upgrade_9_description": "upgrade_security_description",
		"upgrade_10_name": "workshop",
		"upgrade_10_description": "upgrade_workshop_description",
		"upgrade_11_name": "packs",
		"upgrade_11_description": "upgrade_packs_description",
		"upgrade_12_name": "weapons",
		"upgrade_12_description": "upgrade_weapons_description",
		"upgrade_13_name": "tools",
		"upgrade_13_description": "upgrade_tools_description",
		"upgrade_14_name": "kits",
		"upgrade_14_description": "upgrade_kits_description",
		"upgrade_15_name": "spacer",
		"upgrade_20_name": "insight",
		"upgrade_20_description": "upgrade_insight_description",
		"upgrade_21_name": "prowess",
		"upgrade_21_description": "upgrade_prowess_description",
		"upgrade_22_name": "resolve",
		"upgrade_22_description": "upgrade_resolve_description",
		"upgrade_23_name": "personal",
		"upgrade_23_description": "upgrade_personal_description",
		"xp_condition2": "xp_beliefs"
	},
	"defaultValues": {
		"trick": "0",
		"dream": "0",
		"influence": "0",
		"finesse": "0",
		"lurk": "0",
		"fight": "0",
		"hunt": "0",
		"craft": "0",
		"consort": "0",
    "study": "0",
    "survey": "0",
		"force": "0"
	},
	"maxFriendsPerPlaybook": 5,
	"maxContactsPercell": 5,
	"friendlessPlaybooks": [],
	"translatedcellAttributes": ["claim_1_name", "claim_2_name", "claim_3_name", "claim_4_name", "claim_5_name", "claim_6_name", "claim_7_name", "claim_8_name", "claim_9_name", "claim_10_name", "claim_11_name", "claim_12_name", "claim_13_name", "claim_14_name", "claim_15_name", "claim_1_desc", "claim_2_desc", "claim_3_desc", "claim_4_desc", "claim_5_desc", "claim_6_desc", "claim_7_desc", "claim_8_desc", "claim_9_desc", "claim_10_desc", "claim_11_desc", "claim_12_desc", "claim_13_desc", "claim_14_desc", "claim_15_desc", "cohort1_description", "cohort1_name", "cohort1_subtype", "hunting_grounds_type", "hunting_grounds_description", "upgrade_community_1_name", "upgrade_8_name", "cell_description", "cell_xp_condition"],
	"translatedPlaybookAttributes": ["friends_title", "gatherinfo1", "gatherinfo2", "gatherinfo3", "gatherinfo4", "gatherinfo5", "gatherinfo6", "gatherinfo7", "playbook_description","playbook_background","playbook_eminence","xp_condition"]
};
/* global data, getTranslationByKey, getAttrs, setAttrs, on, getSectionIDs, generateRowID, removeRepeatingRow */
const sheetVersion = "0.4";
const sheetName = "Songs for the Dusk";
const getTranslation = (key) => (getTranslationByKey(key) || "NO_TRANSLATION_FOUND");
/* It's necessary to include the base data at the start of the file */
/* Translate all the data */
Object.keys(data.cell).forEach(cell => {
	const base = data.cell[cell].base;
	Object.keys(base).forEach(attr => {
		if (data.translatedcellAttributes.includes(attr)) {
			base[attr] = getTranslation(base[attr]);
		}
	});
	/* Generate cell contacts from translation file */
	data.cell[cell].contact = [...Array(data.maxContactsPercell).keys()].map(i => ({
		name: getTranslation(`cell_${cell}_contact_${i}`)
	}));
	data.cell[cell].cellability = data.cell[cell].cellability.map(name => ({
		name: getTranslation(`cell_ability_${name}`),
		description: getTranslation(`cell_ability_${name}_description`)
	}));
	data.cell[cell].upgrade.forEach(upgrade => {
		upgrade.name = getTranslation(upgrade.name);
		if (upgrade.description) {
			upgrade.description = getTranslationByKey(upgrade.description) || "";
		}
		upgrade.boxes_chosen = "1";
  });
  data.cell[cell].boon.forEach(boon => {
		boon.name = getTranslation(boon.name);
		if (boon.description) {
			boon.description = getTranslationByKey(boon.description) || "";
		}
		boon.boxes_chosen = "1";
	});
});
data.items.forEach(item => {
	item.boxes_chosen = "1";
	item.name = getTranslation(item.name);
	item.description = getTranslationByKey(item.description) || "";
});
Object.keys(data.translatedDefaults).forEach(k => {
	data.translatedDefaults[k] = getTranslation(data.translatedDefaults[k]);
});
Object.assign(data.defaultValues, data.translatedDefaults);
Object.keys(data.factions).forEach(x => {
	data.factions[x].forEach(faction => {
		faction.name = getTranslation(faction.name);
	});
});
Object.keys(data.playbook).forEach(playbook => {
	const base = data.playbook[playbook].base;
	Object.keys(base).forEach(attr => {
		if (data.translatedPlaybookAttributes.includes(attr)) {
			base[attr] = getTranslation(base[attr]);
		}
	});
	/* Generate playbook friends from translation file */
	if (!data.friendlessPlaybooks.includes(playbook)) {
		data.playbook[playbook].friend = [...Array(data.maxFriendsPerPlaybook).keys()]
			.map(i => ({
				name: getTranslation(`playbook_${playbook}_friend_${i}`)
			}))
			.filter(o => o.name);
	}
	else data.playbook[playbook].friend = [];
	data.playbook[playbook].ability = data.playbook[playbook].ability.map(name => ({
		name: getTranslation(`playbook_ability_${name}`),
		description: getTranslation(`playbook_ability_${name}_description`)
	}));
	data.playbook[playbook].playbookitem.forEach(item => {
		item.name = getTranslation(item.name);
		if (item.description) {
			item.description = getTranslationByKey(item.description) || "";
		}
		item.boxes_chosen = "1";
	});
});
const playbookAbilityMap = new Map([...Object.values(data.playbook).map(x => x.ability).reduce((m, v) => {
	v.forEach(a => m.add(a));
	return m;
}, new Set())].map(x => {
	return [x.name.toLowerCase(), x.description];
}));
const cellAbilityMap = new Map([...Object.values(data.cell).map(x => x.cellability).reduce((m, v) => {
	v.forEach(a => m.add(a));
	return m;
}, new Set())].map(x => {
	return [x.name.toLowerCase(), x.description];
}));
/* Utility functions - shouldn't need to touch most of these */
// We define our own wrappers for Roll20 event handlers to provide
// a bit more useful feedback and reduce boilerplate.
function register(attrs, callback) {
  if (typeof attrs == "string") attrs = [attrs];
  console.log(`Registering callback for: ${attrs.join(", ")}`);
  const eventString = attrs.map((x) => `change:${x}`).join(" ");
  on(eventString, (event) => {
    console.log(`Triggering for attribute ${event.sourceAttribute}.`);
    callback(event);
  });
}
function registerOpened(callback) {
  console.log("Registering on sheet opening.");
  on("sheet:opened", () => {
    console.log("Triggering for sheet opening.");
    callback();
  });
}
function registerButton(name, callback) {
  console.log(`Registering for button: ${name}`);
  const throttledFunction = _.throttle(
    (event) => {
      console.log(`Triggering for button: ${name}`);
      callback(event);
    },
    200,
    { trailing: false }
  );
  on(`clicked:${name}`, throttledFunction);
}

function boolToFlag(v) {
  return v ? "1" : "0";
}

const mySetAttrs = (attrs, options, callback) => {
		const finalAttrs = Object.keys(attrs).reduce((m, k) => {
			m[k] = `${attrs[k]}`;
			return m;
		}, {});
		setAttrs(finalAttrs, options, callback);
	},
	setAttr = (name, value) => {
		getAttrs([name], v => {
			const setting = {};
			if (v[name] !== `${value}`) setting[name] = `${value}`;
			setAttrs(setting);
		});
  },  
	fillRepeatingSectionFromData = (sectionName, dataList, autogen, callback) => {
		callback = callback || (() => {});
		getSectionIDs(`repeating_${sectionName}`, idList => {
			const existingRowAttributes = [
				...idList.map(id => `repeating_${sectionName}_${id}_name`),
				...idList.map(id => `repeating_${sectionName}_${id}_autogen`)
			];
			getAttrs(existingRowAttributes, v => {
				/* Delete auto-generated rows */
				if (autogen) {
					idList = idList.filter(id => {
						if (v[`repeating_${sectionName}_${id}_autogen`]) {
							removeRepeatingRow(`repeating_${sectionName}_${id}`);
							return false;
						}
						else return true;
					});
				}
				const existingRowNames = idList.map(id => v[`repeating_${sectionName}_${id}_name`]),
					createdIDs = [],
					setting = dataList.filter(o => !existingRowNames.includes(o.name))
						.map(o => {
							let rowID;
							while (!rowID) {
								let newID = generateRowID();
								if (!createdIDs.includes(newID)) {
									rowID = newID;
									createdIDs.push(rowID);
								}
							}
							const newAttrs = {};
							if (autogen) {
								newAttrs[`repeating_${sectionName}_${rowID}_autogen`] = "1";
							}
							return Object.keys(o).reduce((m, key) => {
								m[`repeating_${sectionName}_${rowID}_${key}`] = o[key];
								return m;
							}, newAttrs);
						})
						.reduce((m, o) => Object.assign(m, o), {});
				mySetAttrs(setting, {}, callback);
			});
		});
	},
	diceMagic = num => {
		const range = end => [...Array(end + 1).keys()].slice(1);
		if (num > 0) return `dice=${range(num).map(() => "[[d6]]").join("&"+"#44"+"; ")}`;
		else return "zerodice=[[d6]]&"+"#44"+"; [[d6]]";
	},
	buildRollFormula = base => {
		return ` {{?{@{bonusdice}|${
			[0, 1, 2, 3, 4, 5, 6, -1, -2, -3].map(n => `${n},${diceMagic(n + (parseInt(base) || 0))}`).join("|")
		}}}}`;
	},
	buildNumdiceFormula = () => {
		return ` {{?{${getTranslation("numberofdice")}|${
			[0, 1, 2, 3, 4, 5, 6].map(n => `${n},${diceMagic(n)}`).join("|")
		}}}}`;
	},
	emptyFirstRowIfUnnamed = sectionName => {
		getSectionIDs(`repeating_${sectionName}`, idList => {
			const id = idList[0];
			getAttrs([`repeating_${sectionName}_${id}_name`], v => {
				if (!v[`repeating_${sectionName}_${id}_name`]) {
					removeRepeatingRow(`repeating_${sectionName}_${id}`);
				}
			});
		});
	},
	handleBoxesFill = (name, upToFour) => {
		on(`change:${name}1 change:${name}2 change:${name}3 change:${name}4`, event => {
			if (event.sourceType !== "player") return;
			getAttrs([event.sourceAttribute], v => {
				const rName = event.sourceAttribute.slice(0, -1),
					setting = {};
				if (String(v[event.sourceAttribute]) === "1") {
					switch (event.sourceAttribute.slice(-1)) {
					case "4":
						setting[`${rName}3`] = 1;
						/* falls through */
					case "3":
						setting[`${rName}2`] = 1;
						/* falls through */
					case "2":
						setting[`${rName}1`] = 1;
					}
				}
				if (String(v[event.sourceAttribute]) === "0") {
					switch (event.sourceAttribute.slice(-1)) {
					case "1":
						setting[`${rName}2`] = 0;
						/* falls through */
					case "2":
						setting[`${rName}3`] = 0;
						/* falls through */
					case "3":
						if (upToFour) setting[`${rName}4`] = 0;
					}
				}
				mySetAttrs(setting);
			});
		});
	},
	calculateResistance = name => {
		getAttrs([...data.actions[name], `setting_resbonus_${name}`], v => {
			const total = data.actions[name].map(x => v[x])
				.reduce((s, c) => s + (`${c}` === "0" ? 0 : 1), 0);
			setAttr(name, total);
			setAttr(`${name}_formula`, buildRollFormula(total + parseInt(v[`setting_resbonus_${name}`])));
		});
	},
	calculateVice = () => {
		getAttrs(Object.keys(data.actions), v => {
			const total = Math.min(...Object.keys(v).map(x => parseInt(v[x]) || 0));
			setAttr("vice_formula", buildRollFormula(total));
		});
	},
	calculateStashFormula = () => getAttrs(["stash"], v => {
		setAttr("stash_formula", buildRollFormula(Math.floor(parseInt(v.stash) / 10)));
	}),
	calculateWantedFormula = () => getAttrs(["wanted"], v => {
		setAttr("wanted_formula", buildRollFormula(v.wanted));
  }),
  calculateProvocationFormula = () => getAttrs(["provocation"], v => {
		setAttr("provocation_formula", buildRollFormula(v.provocation));
	}),
	calculateCohortDice = prefixes => {
		const sourceAttrs = [
			"cell_tier",
			...prefixes.map(p => `${p}_impaired`),
			...prefixes.map(p => `${p}_type`),
			...prefixes.map(p => `${p}_roll_formula`),
		];
		getAttrs(sourceAttrs, v => {
			const setting = {};
			prefixes.forEach(prefix => {
				const dice = (parseInt(v.cell_tier) || 0) - (parseInt(v[`${prefix}_impaired`]) || 0) +
						((v[`${prefix}_type`] === "elite" || v[`${prefix}_type`] === "expert") ? 1 : 0),
					formula = buildRollFormula(dice);
				if (formula !== v[`${prefix}_roll_formula`]) setting[`${prefix}_roll_formula`] = formula;
			});
			setAttrs(setting);
		});
	};
/* CONSTANTS */
const cellAttributes = [...new Set([].concat(...Object.keys(data.cell).map(x => Object.keys(data.cell[x].base))))],
	playbookAttributes = [...new Set([].concat(...Object.keys(data.playbook).map(x => Object.keys(data.playbook[x].base))))],
	watchedAttributes = new Set(cellAttributes.concat(playbookAttributes)),
	actionsFlat = [].concat(...Object.keys(data.actions).map(x => data.actions[x])),
	autoExpandFields = [
		"repeating_ability:name",
		"repeating_ability:description",
		"repeating_cellability:name",
		"repeating_cellability:description",
		"repeating_playbookitem:name",
    "repeating_upgrade:name",
    "repeating_upgrade:description",
    "repeating_boon:name",
		"repeating_friend:name",
		"repeating_contact:name",
		"repeating_clock:name",
		"repeating_cellclock:name",
		"repeating_factionclock:name",
		"repeating_cohort:edges",
		"repeating_cohort:flaws",
		"repeating_alchemical:name",
		"xp_condition",
		"xp_condition_extra",
		"xp_condition2",
		"xp_condition3",
		"cell_xp_condition",
		"hunting_grounds_type",
		"hunting_grounds_description",
		"cohort1_edges",
		"cohort1_flaws",
		"outlook",
    "background",
    "first_eminence",
		"vice_purveyor",
	],
	autogenSections = [
		"ability",
		"cellability",
		"friend",
		"contact",
		"playbookitem",
    "upgrade",
    "boon"
	],
	translatedNames = [...Object.keys(data.playbook), ...Object.keys(data.cell)].reduce((m, keyName) => {
		if (getTranslationByKey(keyName)) m[getTranslationByKey(keyName).toLowerCase()] = keyName;
		else m[keyName.toLowerCase()] = keyName;
		return m;
	}, {});
/* EVENT HANDLERS */
/* Set default fields when setting cell type or playbook */
on("change:cell_type change:playbook", event => {
	getAttrs(["playbook", "cell_type", "changed_attributes", "setting_autofill", ...watchedAttributes], v => {
		const changedAttributes = (v.changed_attributes || "").split(","),
			sourceName = translatedNames[(event.sourceAttribute === "cell_type" ? v.cell_type : v.playbook).toLowerCase()],
			fillBaseData = (inputData, defaultAttrNames) => {
				if (data) {
					const finalSettings = defaultAttrNames.filter(name => !changedAttributes.includes(name))
						// do not reset attributes which have been changed by the user
						.filter(name => v[name] !== (data.defaultValues[name] || ""))
						// do not set attributes if current value is equal to sheet defaults
						.reduce((m, name) => {
							m[name] = data.defaultValues[name] || "";
							return m;
						}, {});
					Object.keys(inputData).filter(name => !changedAttributes.includes(name))
						.forEach(name => (finalSettings[name] = inputData[name]));
					mySetAttrs(finalSettings);
				}
			};
		if (event.sourceAttribute === "cell_type" ? v.cell_type : v.playbook) {
			setAttr("show_playbook_reminder", "0");
		}
		if (v.setting_autofill !== "1") return;
		if (event.sourceAttribute === "cell_type" && sourceName in data.cell) {
			fillRepeatingSectionFromData("contact", data.cell[sourceName].contact, true);
			fillRepeatingSectionFromData("cellability", data.cell[sourceName].cellability, true);
      fillRepeatingSectionFromData("upgrade", data.cell[sourceName].upgrade, true);
      fillRepeatingSectionFromData("boon", data.cell[sourceName].boon, true);
			fillBaseData(data.cell[sourceName].base, cellAttributes);
		}
		if (event.sourceAttribute === "playbook" && sourceName in data.playbook) {
			fillRepeatingSectionFromData("friend", data.playbook[sourceName].friend, true);
			fillRepeatingSectionFromData("ability", data.playbook[sourceName].ability, true);
			fillRepeatingSectionFromData("playbookitem", data.playbook[sourceName].playbookitem, true);
			fillBaseData(data.playbook[sourceName].base, playbookAttributes);
    }
	});
});
const fillPlaybookAbility = () => {
	const prefix = "repeating_ability";
	getAttrs([`${prefix}_name`, `${prefix}_description`], v => {
		if (!v[`${prefix}_description`]) {
			const description = playbookAbilityMap.get((v[`${prefix}_name`] || "").toLowerCase());
			if (description) setAttr(`${prefix}_description`, description);
		}
	});
};
const fillcellAbility = () => {
	const prefix = "repeating_cellability";
	getAttrs([`${prefix}_name`, `${prefix}_description`], v => {
		if (!v[`${prefix}_description`]) {
			const description = cellAbilityMap.get((v[`${prefix}_name`] || "").toLowerCase());
			if (description) setAttr(`${prefix}_description`, description);
		}
	});
};
on("change:repeating_ability:name", fillPlaybookAbility);
on("change:repeating_cellability:name", fillcellAbility);
/* Watch repeating rows for changes and set autogen to false if change happens */
autogenSections.forEach(sectionName => {
	on(`change:repeating_${sectionName}`, event => {
		getAttrs([`repeating_${sectionName}_autogen`], v => {
			if (v[`repeating_${sectionName}_autogen`] && event.sourceType === "player") {
				setAttr(`repeating_${sectionName}_autogen`, "");
			}
		});
	});
});
/* Watch for changes in auto-set attributes and update changed_attributes*/
watchedAttributes.forEach(name => {
	on(`change:${name}`, event => {
		if (event.sourceType === "player") {
			getAttrs(["changed_attributes"], v => {
				const changedAttributes = [...new Set(v.changed_attributes.split(",")).add(name)]
					.filter(x => !!x).join(",");
				setAttr("changed_attributes", changedAttributes);
			});
		}
	});
});
/* Register attribute/action event handlers */
Object.keys(data.actions).forEach(attrName => {
	on([...data.actions[attrName], `setting_resbonus_${attrName}`]
		.map(x => `change:${x}`).join(" "), () => calculateResistance(attrName)
	);
	on(`change:${attrName}`, calculateVice);
});
/* Calculate stash */
on("change:stash", calculateStashFormula);
on("change:wanted", calculateWantedFormula);
on("change:provocation", calculateProvocationFormula);
/* Calculate trauma */
on(data.traumas.map(x => `change:trauma_${x}`).join(" "), event => {
	getAttrs(data.traumas.map(x => `trauma_${x}`), v => {
		if (event.sourceType === "player") {
			const newTrauma = data.traumas.reduce((m, name) => m + (parseInt(v[`trauma_${name}`]) || 0), 0);
			setAttr("trauma", newTrauma);
		}
	});
});
/* Generate buttons */
on("change:generate_factions", () => {
	setAttr("show_faction_generatebutton", "0");
	Object.keys(data.factions).forEach(sectionName => {
		fillRepeatingSectionFromData(sectionName, data.factions[sectionName]);
	});
});
autogenSections.forEach(sectionName => {
	on(`change:generate_${sectionName}`, () => {
		getAttrs(["generate_source_character", "generate_source_cell", "sheet_type"], v => {
			const dataVar = (v.sheet_type === "character") ? data.playbook : data.cell,
				genSource = v[`generate_source_${v.sheet_type}`];
			if (genSource in dataVar) {
				emptyFirstRowIfUnnamed(sectionName);
				fillRepeatingSectionFromData(sectionName, dataVar[genSource][sectionName]);
			}
		});
	});
});
/* Extra stress and trauma */
on("change:setting_extra_stress", event => setAttr("stress_max", 9 + (parseInt(event.newValue) || 0)));
on("change:setting_extra_trauma", event => setAttr("trauma_max", 4 + (parseInt(event.newValue) || 0)));

/* Calculate cohort quality */
on(["cell_tier", "cohort1_impaired", "cohort1_type"].map(x => `change:${x}`).join(" "), () => calculateCohortDice(["cohort1"]));
on("change:repeating_cohort", () => calculateCohortDice(["repeating_cohort"]));
on("change:cell_tier", () => {
	getSectionIDs("repeating_cohort", a => calculateCohortDice(a.map(id => `repeating_cohort_${id}`)));
});
on("change:char_cohort_quality change:char_cohort_impaired change:setting_show_cohort", () => {
	getAttrs(["char_cohort_quality", "char_cohort_impaired"], v => {
		const dice = (parseInt(v.char_cohort_quality) || 0) - (parseInt(v.char_cohort_impaired) || 0);
		setAttr("char_cohort_roll_formula", buildRollFormula(dice));
	});
});
/* Set correct verb for cohort roll button */
["char_cohort", "cohort1", "repeating_cohort"].forEach(prefix => {
	const eventString = "change:" + ((prefix === "repeating_cohort") ? `${prefix}:type` : `${prefix}_type`);
	on(eventString, event => {
		const verb = (event.newValue === "expert") ? "^{rolls_their}" : "^{roll_their}";
		setAttr(`${prefix}_verb`, verb);
	});
});
/* Left-fill checkboxes */
handleBoxesFill("upgrade_24_check_", true);
handleBoxesFill("bandolier1_check_");
handleBoxesFill("bandolier2_check_");
["item", "playbookitem", "upgrade", "boon"].forEach(sName => handleBoxesFill(`repeating_${sName}:check_`));
/* Pseudo-radios */
["cell_tier", ...actionsFlat].forEach(name => {
	on(`change:${name}`, event => {
		if (String(event.newValue) === "0" && event.sourceType === "player") {
			setAttr(name, (parseInt(event.previousValue) || 1) - 1);
		}
		setAttr(`${name}_formula`, buildRollFormula(event.newValue || "0"));
	});
});
/* Item reset button */
on("change:reset_items", () => {
	const clearChecks = sectionName => {
		getSectionIDs(`repeating_${sectionName}`, idArray => {
			const setting = [
				...idArray.map(id => `repeating_${sectionName}_${id}_check_1`),
				...idArray.map(id => `repeating_${sectionName}_${id}_check_2`),
				...idArray.map(id => `repeating_${sectionName}_${id}_check_3`)
			].reduce((m, name) => {
				m[name] = 0;
				return m;
			}, {});
			mySetAttrs(setting);
		});
	};
	setAttr("load", 0);
	["item", "playbookitem"].forEach(clearChecks);
});
/* Default values for number of upgrades boxes — probably not necessary anymore */
// on('change:repeating_upgrade:boxes_chosen', () => {
// 	getAttrs(['repeating_upgrade_numboxes'], v => {
// 		if (!['1', '2', '3'].includes(v.repeating_upgrade_numboxes)) {
// 			setAttr('repeating_upgrade_numboxes', '1');
// 		}
// 	});
// });
/* Resistance query */
on("change:setting_consequence_query sheet:opened", () => {
	getAttrs(["setting_consequence_query"], v => {
		const consequenceQuery = (String(v.setting_consequence_query) === "1") ?
			`?{${getTranslation("consequence")}|${getTranslation("a_consequence")}}` :
			"^{a_consequence}";
		setAttr("consequence_query", consequenceQuery);
	});
});
/* Trim whitespace in auto-expand fields */
autoExpandFields.forEach(name => {
	on(`change:${name}`, event => {
		const attrName = name.replace(":", "_");
		getAttrs([attrName], v => {
			if (v[attrName].trim() !== v[attrName] && event.sourceType === "player") {
				setAttr(attrName, v[attrName].trim());
			}
		});
	});
});
/* Clean chat image URL */
on("change:chat_image", event => {
	const match = (event.newValue || "").match(/^(https:\/\/s3\.amazonaws\.com\/files\.d20\.io\/images\/.*\.jpg)\?\d+$/);
	if (match) setAttr("chat_image", match[1]);
});
/* Number of dice prompt */
on("sheet:opened", () => {
	/* Set up translated attributes */
	const translatedAttrs = {
		bonusdice: getTranslation("bonusdice"),
		effect_query: getTranslation("effect_query"),
		notes_query: `?{${getTranslation("notes")}}`,
		numberofdice: buildNumdiceFormula(),
		position_query: `?{${getTranslation("position")}|` +
			`${getTranslation("risky")},position=${getTranslation("risky")}|` +
			`${getTranslation("controlled")},position=${getTranslation("controlled")}|` +
			`${getTranslation("desperate")},position=${getTranslation("desperate")}|` +
			`${getTranslation("fortune_roll")},position=}`,
	};
	getAttrs(Object.keys(translatedAttrs), v => {
		const setting = {};
		Object.keys(translatedAttrs).forEach(name => {
			if (v[name] !== translatedAttrs[name]) setting[name] = translatedAttrs[name];
		});
		mySetAttrs(setting);
	});
});
/* INITIALISATION AND UPGRADES */
on("sheet:opened", () => {
	getAttrs(["sheet_type", "changed_attributes", "cell_type", "playbook"], v => {
		/* Make sure sheet_type is never 0 */
		if (!["cell", "faction"].includes(v.sheet_type)) setAttr("sheet_type", "character");
		/* Remove reminder box if we have playbook or cell name */
		if (v.playbook || v.cell_type) setAttr("show_playbook_reminder", "0");
	});
	/* Setup and upgrades */
	getAttrs(["version"], v => {
		const upgradeSheet = version => {
				// const [major, minor] = version && version.split(".").map(x => parseInt(x));
				console.log(`Found version ${version}.`);
			},
			initialiseSheet = () => {
				const setting = ["ability", "friend", "cellability", "contact", "playbookitem", "upgrade", "boon", "framefeature"]
					.reduce((memo, sectionName) => {
						memo[`repeating_${sectionName}_${generateRowID()}_autogen`] = 1;
						return memo;
					}, {});
				mySetAttrs(setting);
				fillRepeatingSectionFromData("item", data.items);
				/* Set translated default values */
				getAttrs(Object.keys(data.translatedDefaults), v => {
					const setting = {};
					Object.keys(data.translatedDefaults).forEach(k => {
						if (v[k] !== data.translatedDefaults[k]) setting[k] = data.translatedDefaults[k];
					});
					mySetAttrs(setting);
				});
				console.log("Initialising new sheet.");
			};
		if (v.version) upgradeSheet(v.version);
		else initialiseSheet();
		// Set version number
		mySetAttrs({
			version: sheetVersion,
			character_sheet: `${sheetName} v${sheetVersion}`,
		});
	});
});

/*Outlook*/
function handleEveryInchA(event) {
  getAttrs(["repeating_ability_name", "setting_num_outlook_traits"], (v) => {
    const isOutlookAbility =
      v.repeating_ability_name.slice(0, -3) ===
      getTranslation(ABILITY_PLUS_OUTLOOK).slice(0, -3);
    if (!isOutlookAbility) return;
    const delta = String(event.newValue) === "1" ? 2 : -2;
    mySetAttrs(
      {
        setting_num_outlook_traits:
          parseInt(v.setting_num_outlook_traits) + delta,
      },
      { silent: false }
    );
  });
}

function handleGottaMakeItOutAlive(event) {
  getAttrs(
    ["playbook", "repeating_ability_name", "setting_extra_trauma"],
    (v) => {
      const isTraumaAbility =
        v.repeating_ability_name ===
        getTranslation(ABILITY_ROOKIE_EXTRA_TRAUMA);
      if (!isTraumaAbility || v.playbook !== getTranslation("playbook_rookie"))
        return;
      const delta = String(event.newValue) === "1" ? 1 : -1;
      mySetAttrs({
        setting_extra_trauma: parseInt(v.setting_extra_trauma) + delta,
      });
    }
  );
}

function handleOutlookChoice() {
  getAttrs([...outlookAttrs, "setting_num_outlook_traits"], (v) => {
    const setting = {};
    const maxTraits = parseInt(v["setting_num_outlook_traits"]) || 0;
    const traitCounts = Object.entries(outlookData).reduce(
      (m, [k, traits]) => {
        m[k] = traits.reduce(
          (m, trait) => m + parseInt(v[`trait_${trait}`]) || 0,
          0
        );
        return m;
      },
      {}
    );
    const totalTraits = Object.values(traitCounts).reduce((m, a) => m + a, 0);
    setting.outlook_traits_chosen = boolToFlag(totalTraits >= maxTraits);
    Object.keys(outlookData).forEach((outlook) => {
      setting[`show_outlook_${outlook}`] = boolToFlag(
        totalTraits === 0 || traitCounts[outlook] > 0
      );
    });
    mySetAttrs(setting);
  });
}


const outlookData = {
  doomsayer: ["debater", "dreamer", "searcher", "skeptic"],
  herite: ["anarchic", "free_thinker", "subversive", "suspicious"],
  jacker: ["driven", "protective", "vengeful", "warrior"],
  lightbringer: ["connected", "manipulator", "motivator", "political"],
};

const ABILITY_PLUS_OUTLOOK = "playbook_ability_every_inch_a";
const ABILITY_ROOKIE_EXTRA_TRAUMA = "playbook_ability_gotta_make_it_out_alive";

const outlookAttrs = []
  .concat(...Object.values(outlookData))
  .map((x) => `trait_${x}`); 
 


/*Outlook*/
register("repeating_ability:check", handleEveryInchA);
register("repeating_ability:check", handleGottaMakeItOutAlive);
register(    
[...outlookAttrs, "setting_num_outlook_traits"],
handleOutlookChoice
);


